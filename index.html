<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rituva Weather</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<style>
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{
  margin:0;min-height:100vh;display:flex;justify-content:center;
  padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);
  transition:.3s;
}
body.dark{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364)}
.app{
  width:100%;max-width:380px;min-height:100vh;
  padding:16px;border-radius:22px;
  background:rgba(255,255,255,.18);
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.35);
}
body.dark .app{background:rgba(0,0,0,.35);color:#fff}
input,button{
  width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:8px
}
button{background:rgba(255,255,255,.4);font-weight:bold;cursor:pointer}
.details{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.detail-card{background:rgba(255,255,255,.25);border-radius:16px;padding:12px;text-align:center}
.big{font-size:26px;font-weight:bold}
.hourly,.forecast{display:flex;gap:10px;overflow-x:auto;padding:8px}
.hour,.day{text-align:center;min-width:34px}
.hour-bar,.day-bar-max,.day-bar-min{border-radius:6px 6px 0 0;animation:grow .6s}
@keyframes grow{from{height:0}}
.loading{
  position:absolute;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(255,255,255,.35);border-radius:22px
}
.aqi-good{color:#00e676}
.aqi-moderate{color:#ffeb3b}
.aqi-poor{color:#ff9800}
.aqi-severe{color:#f44336}
@media(min-width:700px){
  .app{max-width:900px}
  .details{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>

<body>
<div class="app">

<h2>ğŸŒ¦ Rituva</h2>

<input id="cityInput" placeholder="Search city">
<button onclick="searchCity()">Search</button>
<button onclick="requestLocation()">ğŸ“ Use My Location</button>
<button id="installBtn" style="display:none">ğŸ“² Install Rituva</button>

<div id="favorites" style="margin-bottom:6px"></div>

<div class="loading" id="loading">Detecting locationâ€¦</div>

<h3 id="location">Loadingâ€¦</h3>
<p id="accuracy" style="font-size:11px;opacity:.8">Accuracy: --</p>

<div style="font-size:48px" id="icon">â›…</div>
<p id="temp">--Â°</p>
<p id="feels">Feels like --</p>
<p id="wind">Wind --</p>
<p id="gust">Gust --</p>
<p id="humidity">Humidity --</p>
<p id="updated">Updated --</p>

<div id="alertBox" style="display:none;padding:10px;border-radius:12px;margin:10px 0"></div>

<div class="details">
  <div class="detail-card">
    <h4>ğŸ§­ Direction</h4>
    <div id="compassValue" class="big">--Â°</div>
    <div id="compassDir">--</div>
  </div>
  <div class="detail-card" id="aqiCard">
    <h4>ğŸŒ« AQI</h4>
    <div id="aqiValue" class="big">--</div>
    <div id="aqiLabel">--</div>
    <div id="aqiAdvice"></div>
  </div>
</div>

<h4>ğŸ•’ Next 24 Hours</h4>
<div class="hourly" id="hourlyTemp"></div>

<h4>ğŸ“… 7-Day Forecast</h4>
<div class="forecast" id="forecast"></div>

<footer style="font-size:11px;text-align:center;margin-top:14px">
Â© Manik Roy 2025
</footer>

</div>

<script>
const icons={0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",61:"ğŸŒ§",71:"â„",95:"â›ˆ"};
const loading=document.getElementById("loading");

/* ---------- utilities ---------- */
function showLoading(v){loading.style.display=v?"flex":"none"}
function compassDir(d){return["N","NE","E","SE","S","SW","W","NW"][Math.round(d/45)%8]}

/* ---------- theme memory ---------- */
function applyTheme(t){
  document.body.classList.toggle("dark",t==="dark");
  localStorage.setItem("rituva_theme",t);
}
applyTheme(localStorage.getItem("rituva_theme"));
document.addEventListener("dblclick",()=>{
  applyTheme(document.body.classList.contains("dark")?"light":"dark");
});

/* ---------- compass ---------- */
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation",e=>{
    if(e.alpha!=null){
      compassValue.textContent=Math.round(e.alpha)+"Â°";
      compassDir.textContent=compassDir(e.alpha);
    }
  });
}

/* ---------- favorites ---------- */
function favs(){return JSON.parse(localStorage.getItem("rituva_favs")||"[]")}
function saveFavs(f){localStorage.setItem("rituva_favs",JSON.stringify(f))}
function addFav(lat,lon,name){
  const f=favs();
  if(!f.find(x=>x.name===name)){f.push({lat,lon,name});saveFavs(f)}
  renderFavs();
}
function renderFavs(){
  favorites.innerHTML=favs().map(f=>`<button onclick="loadWeather(${f.lat},${f.lon},'${f.name}')">${f.name}</button>`).join(" ");
}
renderFavs();

/* ---------- cache ---------- */
function saveCache(d){localStorage.setItem("rituva_cache",JSON.stringify(d))}
function loadCache(){try{return JSON.parse(localStorage.getItem("rituva_cache"))}catch{return null}}

/* ---------- alerts ---------- */
function showAlerts(w,pm){
  alertBox.style.display="none";
  if(w.current_weather.temperature>=38){
    alertBox.textContent="ğŸ”¥ Heat Alert";alertBox.style.display="block";
  } else if(pm>90){
    alertBox.textContent="ğŸŒ« AQI Severe";alertBox.style.display="block";
  } else if(w.current_weather.weathercode>=61){
    alertBox.textContent="ğŸŒ§ Rain expected";alertBox.style.display="block";
  }
}

/* ---------- weather ---------- */
async function loadWeather(lat,lon,name){
try{
showLoading(true);

const w=await fetch(
`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,apparent_temperature,relativehumidity_2m,windgusts_10m,precipitation_probability&daily=temperature_2m_min,temperature_2m_max,weathercode&timezone=auto`
).then(r=>r.json());

const a=await fetch(
`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`
).then(r=>r.json());

location.textContent=name;
temp.textContent=w.current_weather.temperature+"Â°C";
feels.textContent="Feels "+w.hourly.apparent_temperature[0]+"Â°C";
wind.textContent="Wind "+w.current_weather.windspeed+" km/h";
gust.textContent="Gust "+w.hourly.windgusts_10m[0]+" km/h";
humidity.textContent="Humidity "+w.hourly.relativehumidity_2m[0]+"%";
icon.textContent=icons[w.current_weather.weathercode]||"â›…";
updated.textContent="Updated "+new Date().toLocaleTimeString();

const pm=a.hourly.pm2_5[0];
aqiValue.textContent=pm;
aqiLabel.textContent=pm<=30?"Good":pm<=60?"Moderate":pm<=90?"Poor":"Severe";
showAlerts(w,pm);

hourlyTemp.innerHTML="";
w.hourly.temperature_2m.slice(0,24).forEach((t,i)=>{
  const rain=w.hourly.precipitation_probability[i]||0;
  hourlyTemp.innerHTML+=`
  <div class="hour">
    <div class="hour-bar" style="height:${20+t}px;background:#90caf9"></div>
    <div>${t}Â°</div><div>${rain}%</div>
  </div>`;
});

forecast.innerHTML="";
w.daily.time.forEach((d,i)=>{
  forecast.innerHTML+=`
  <div class="day">
    <div class="day-bar-max" style="height:${20+w.daily.temperature_2m_max[i]}px;background:#ff7043"></div>
    <div class="day-bar-min" style="height:${20+w.daily.temperature_2m_min[i]}px;background:#42a5f5"></div>
    <div>${icons[w.daily.weathercode[i]]||"â›…"}</div>
    <div>${d.slice(5)}</div>
  </div>`;
});

saveCache({w,a,name,lat,lon});
addFav(lat,lon,name);

}catch{
const c=loadCache();
if(c){
  location.textContent=c.name+" (Offline)";
  temp.textContent=c.w.current_weather.temperature+"Â°C";
}
}finally{showLoading(false)}
}

/* ---------- location (MOBILE SAFE) ---------- */
async function getLocationName(lat,lon){
const r=await fetch(
`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1`
).then(r=>r.json());
return r.results?`${r.results[0].name}, ${r.results[0].country}`:"Current Location";
}

function requestLocation(){
showLoading(true);
navigator.geolocation.getCurrentPosition(
async p=>{
accuracy.textContent="Accuracy Â±"+Math.round(p.coords.accuracy)+" m";
loadWeather(p.coords.latitude,p.coords.longitude,
await getLocationName(p.coords.latitude,p.coords.longitude));
},
()=>{showLoading(false);alert("Location unavailable");},
{enableHighAccuracy:true,timeout:12000,maximumAge:60000}
);
}

/* ---------- bootstrap (NO AUTO GPS) ---------- */
const cached=loadCache();
if(cached){
  loadWeather(cached.lat,cached.lon,cached.name);
}else{
  loadWeather(28.61,77.23,"Delhi, India");
}

/* ---------- PWA ---------- */
let dp;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();dp=e;installBtn.style.display="block";
});
installBtn.onclick=()=>{dp.prompt();dp=null};
</script>
</body>
</html>
