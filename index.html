<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rituva</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
margin:0;min-height:100vh;display:flex;justify-content:center;
padding:12px;background:linear-gradient(135deg,#667eea,#764ba2)
}
.app{
width:100%;max-width:380px;padding:16px;border-radius:22px;
background:rgba(255,255,255,.18);backdrop-filter:blur(16px)
}
input,button{
width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px
}
button{font-weight:bold;background:rgba(255,255,255,.35)}
.details{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{
background:rgba(255,255,255,.25);
border-radius:14px;padding:10px;text-align:center;font-size:13px
}
.big{font-size:26px;font-weight:bold}
.hourly{display:flex;gap:8px;overflow-x:auto}
.hour{display:flex;flex-direction:column;align-items:center}
.bar{width:18px;border-radius:6px 6px 0 0}
.bar.aqi{background:#43a047}
.bar.temp{background:#ff7043}
#map{height:260px;border-radius:16px}

/* Dark / OLED */
body.dark{background:#121212}
body.oled{background:#000000}
body.dark .app,body.oled .app{background:#000}
body.dark *,body.oled *{color:#fff}
body.dark input,body.dark button,
body.oled input,body.oled button{background:#1f1f1f;color:#fff}
body.oled #map{filter:grayscale(1) brightness(.8)}
</style>
</head>

<body>
<div class="app">

<h1>ğŸŒ¦ Rituva</h1>
<button id="themeBtn">ğŸŒ™ Dark Mode</button>
<button id="installBtn" hidden>ğŸ“² Install App</button>

<input id="cityInput" placeholder="Search city">
<button onclick="searchCity()">Search</button>
<button onclick="useLocation()">ğŸ“ Use My Location</button>

<h2 id="location">Loadingâ€¦</h2>
<p id="temp">--Â°C</p>

<div class="details">
<div class="card">
<h4>AQI</h4>
<div id="aqiValue" class="big">--</div>
<div id="aqiLabel">--</div>
</div>
<div class="card">
<h4>Wind</h4>
<div id="wind">--</div>
</div>
</div>

<h3>ğŸŒ« AQI Insights</h3>
<div class="details" id="aqiInsights"></div>

<h3>ğŸ“ Current Location Details</h3>
<div class="details" id="locationDetails"></div>

<h3>ğŸ“ˆ AQI (24H)</h3>
<div class="hourly" id="aqiGraph"></div>

<h3>ğŸŒ¡ Temperature (24H)</h3>
<div class="hourly" id="tempGraph"></div>

<h3>ğŸ“… 7-Day Forecast</h3>
<div class="details" id="temp7d"></div>

<h3>ğŸ—º Pollution Heatmap</h3>
<div id="map"></div>

<footer style="text-align:center;font-size:11px;margin-top:15px">
Â© Manik Roy 2025. All Rights Reserved.
</footer>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
const $=id=>document.getElementById(id);
const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;
const compass=d=>["N","NE","E","SE","S","SW","W","NW"][Math.round(d/45)%8];

/* THEME */
let theme=localStorage.getItem("theme")||"light";
applyTheme();
$("themeBtn").onclick=()=>{
theme=theme==="light"?"dark":theme==="dark"?"oled":"light";
localStorage.setItem("theme",theme);applyTheme();
};
function applyTheme(){
document.body.classList.remove("dark","oled");
if(theme==="dark"){document.body.classList.add("dark");$("themeBtn").textContent="ğŸ–¤ OLED";}
else if(theme==="oled"){document.body.classList.add("oled");$("themeBtn").textContent="â˜€ Light";}
else{$("themeBtn").textContent="ğŸŒ™ Dark";}
}

/* CPCB AQI */
const calc=(c,b)=>Math.round(((b[3]-b[2])/(b[1]-b[0]))*(c-b[0])+b[2]);
const PM25=c=>{for(let i of [[0,30,0,50],[31,60,51,100],[61,90,101,200],[91,120,201,300],[121,250,301,400],[251,500,401,500]])if(c<=i[1])return calc(c,i)};
const PM10=c=>{for(let i of [[0,50,0,50],[51,100,51,100],[101,250,101,200],[251,350,201,300],[351,430,301,400],[431,600,401,500]])if(c<=i[1])return calc(c,i)};

/* LAST 24 HOURS (ACCURATE) */
function last24(arr){ return arr.slice(-24); }
function hourLabel(i){ const d=new Date(); d.setHours(d.getHours()-23+i); return d.getHours() + ":00"; }

/* MAP */
let map,heat;
function drawMap(lat,lon,aqi){
if(!map){ map=L.map("map").setView([lat,lon],11); L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);}
else map.setView([lat,lon],11);
if(heat)map.removeLayer(heat);
const i=aqi<=50?.2:aqi<=100?.4:aqi<=150?.6:aqi<=200?.8:1;
heat=L.heatLayer([[lat,lon,i],[lat+.02,lon+.02,i*.8],[lat-.02,lon-.02,i*.7]],{radius:40,blur:25}).addTo(map);
}

/* RENDER GRAPHS */
function renderAQI24H(pm25,pm10){
$("aqiGraph").innerHTML="";
pm25.forEach((v,i)=>{
const aqi=Math.max(PM25(v),PM10(pm10[i]));
const h=Math.max(8,(aqi/500)*120);
$("aqiGraph").innerHTML+=`<div class="hour"><div class="bar aqi" style="height:${h}px"></div><small>${hourLabel(i)}</small></div>`;
});
}
function renderTemp24H(t){
$("tempGraph").innerHTML="";
t.forEach((v,i)=>{
const h=Math.max(8,(v/50)*120);
$("tempGraph").innerHTML+=`<div class="hour"><div class="bar temp" style="height:${h}px"></div><small>${hourLabel(i)}</small></div>`;
});
}
function render7Day(max,min){
$("temp7d").innerHTML="";
max.forEach((v,i)=>{$("temp7d").innerHTML+=`<div class="card">Day ${i+1}<br><b>${v}Â° / ${min[i]}Â°</b></div>`;});
}

/* LOAD DATA */
async function load(lat,lon,name){
$("location").textContent=name;

const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`).then(r=>r.json());
const a=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10&timezone=auto`).then(r=>r.json());

$("temp").textContent=w.current_weather.temperature+"Â°C";
$("wind").textContent=w.current_weather.windspeed+" km/h "+compass(w.current_weather.winddirection);

const pm25_24=last24(a.hourly.pm2_5);
const pm10_24=last24(a.hourly.pm10);
const temp_24=last24(w.hourly.temperature_2m);

const aqi=Math.max(PM25(avg(pm25_24)),PM10(avg(pm10_24)));
$("aqiValue").textContent=aqi;
$("aqiLabel").textContent=aqi<=50?"Good":aqi<=100?"Satisfactory":aqi<=200?"Moderate":aqi<=300?"Poor":"Severe";

renderAQI24H(pm25_24,pm10_24);
renderTemp24H(temp_24);
render7Day(w.daily.temperature_2m_max,w.daily.temperature_2m_min);

/* AQI INSIGHTS */
$("aqiInsights").innerHTML=`
<div class="card">Category<br><b>${$("aqiLabel").textContent}</b></div>
<div class="card">Dominant Pollutant<br><b>PM2.5</b></div>
<div class="card">Health Risk<br><b>${aqi>200?"High":"Moderate"}</b></div>
<div class="card">Mask Advice<br><b>${aqi<=100?"Optional":"N95"}</b></div>
<div class="card">Outdoor Safety<br><b>${aqi<=100?"Safe":"Limit"}</b></div>
<div class="card">Children<br><b>${aqi<=100?"Normal":"Avoid Outdoor"}</b></div>
<div class="card">Elderly<br><b>${aqi<=100?"Safe":"Stay Indoors"}</b></div>
<div class="card">Sensitive Groups<br><b>${aqi<=100?"Low":"High Risk"}</b></div>
<div class="card">Trend<br><b>Last 24 Hours</b></div>
<div class="card">Standard<br><b>CPCB</b></div>
`;

/* LOCATION DETAILS */
$("locationDetails").innerHTML=`
<div class="card">Latitude<br><b>${lat.toFixed(4)}</b></div>
<div class="card">Longitude<br><b>${lon.toFixed(4)}</b></div>
<div class="card">City<br><b>${name}</b></div>
<div class="card">Timezone<br><b>${w.timezone}</b></div>
<div class="card">Local Time<br><b>${new Date().toLocaleTimeString()}</b></div>
<div class="card">Sunrise<br><b>${w.daily.sunrise[0]}</b></div>
<div class="card">Sunset<br><b>${w.daily.sunset[0]}</b></div>
<div class="card">Elevation<br><b>${w.elevation} m</b></div>
<div class="card">Location Type<br><b>GPS/Search</b></div>
<div class="card">AQI Source<br><b>Open-Meteo</b></div>
`;

drawMap(lat,lon,aqi);
}

/* SEARCH & LOCATION */
async function searchCity(){
const q=$("cityInput").value.trim();
if(!q)return;
const g=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json());
load(g.results[0].latitude,g.results[0].longitude,g.results[0].name);
}
function useLocation(){
navigator.geolocation.getCurrentPosition(p=>load(p.coords.latitude,p.coords.longitude,"Current Location"));
}

load(28.61,77.23,"Delhi, India");

/* PWA */
if("serviceWorker"in navigator)navigator.serviceWorker.register("sw.js");
let dp;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();dp=e;$("installBtn").hidden=false;
});
$("installBtn").onclick=()=>dp.prompt();
</script>
</body>
</html>
