<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rituva</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<style>
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:12px;transition:background 0.3s,color 0.3s;overflow:auto;background:linear-gradient(135deg,#667eea,#764ba2);color:#000;}
.app{width:100%;max-width:380px;min-height:100vh;padding:16px;border-radius:22px;backdrop-filter:blur(18px);background:rgba(255,255,255,0.18);display:flex;flex-direction:column;align-items:stretch;overflow-y:auto;overflow-x:hidden;}
input,button{width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px;text-align:center;}
button{background: rgba(255,255,255,0.35); font-weight:bold;}
.icon{font-size:48px;text-align:center;}
.details{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:15px;}
.detail-card{background: rgba(255,255,255,0.2);border-radius:16px;padding:12px;text-align:center;}
.hourly, .forecast{display:flex;gap:10px;overflow-x:auto;margin-top:12px;align-items:flex-end;height:140px;padding:8px;}
.hour, .day{min-width:24px;display:flex;flex-direction: column;justify-content:flex-end;align-items:center;}
footer{margin-top:24px;font-size:11px;opacity:0.8;text-align:center;}
@media(max-width:420px){.details{grid-template-columns:1fr;}}
body.dark{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:#fff;}
body.dark .app{background: rgba(0,0,0,0.25);color:#fff;}
body.dark input,body.dark button{background: rgba(255,255,255,0.1);color:#fff;}
#installBtn{display:none;margin-top:10px;background: rgba(255,255,255,0.5);font-weight:bold;border-radius:12px;width:100%;padding:12px;transition:background 0.3s;}
#installBtn:hover{background: rgba(255,255,255,0.7);cursor:pointer;}
.loading-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.25);backdrop-filter:blur(10px);display:flex;justify-content:center;align-items:center;font-size:18px;border-radius:20px;display:none;}
</style>
</head>
<body>
<div class="app">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h1>ğŸŒ¦ Rituva</h1>
    <button id="darkToggle">ğŸŒ“</button>
  </div>
  <input id="cityInput" placeholder="Search city">
  <button onclick="searchCity()">Search</button>
  <button id="locateBtn">ğŸ“ Locate Me</button>
  <button id="installBtn">ğŸ“² Install Rituva</button>

  <div class="loading-overlay" id="loading">Loading...</div>

  <div class="current">
    <h2 id="location">Detecting locationâ€¦</h2>
    <div id="icon" class="icon">â›…</div>
    <p id="temp">--Â°</p>
    <p id="wind">ğŸŒ¬ -- km/h</p>
  </div>

  <div class="details">
    <div class="detail-card" id="aqiCard"></div>
    <div class="detail-card" id="compassDiv"></div>
  </div>

  <h3>ğŸ•’ Next 24 Hours</h3>
  <div class="hourly" id="hourlyTemp"></div>

  <h3>ğŸ“… 7-Day Forecast</h3>
  <div class="forecast" id="forecast"></div>

  <footer>Â© Manik Roy 2025. All Rights Reserved.</footer>
</div>

<script>
// Weather icons
const icons = {0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",61:"ğŸŒ§",71:"â„",95:"â›ˆ"};

// AQI helper
function aqiInfo(pm){
  if(pm<=30) return {label:"Good", advice:"Safe outdoors"};
  if(pm<=60) return {label:"Moderate", advice:"Sensitive reduce exposure"};
  if(pm<=90) return {label:"Poor", advice:"Avoid long outdoor stay"};
  return {label:"Severe", advice:"Stay indoors"};
}

// Compass helper
function compassDirection(deg){
  const dirs = ["N","NE","E","SE","S","SW","W","NW"];
  return dirs[Math.round(deg/45)%8];
}

// Show/hide loading
function showLoading(show){document.getElementById('loading').style.display=show?'flex':'none';}

// Main weather loader
async function loadWeather(lat, lon, name="Your Location"){
  try{
    showLoading(true);
    const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m&daily=temperature_2m_min,temperature_2m_max,weathercode&timezone=auto`);
    const w = await wRes.json();
    const aRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`);
    const a = await aRes.json();

    document.getElementById("location").textContent = name;
    document.getElementById("temp").textContent = "ğŸŒ¡ "+w.current_weather.temperature+"Â°C";
    document.getElementById("wind").textContent = "ğŸŒ¬ "+w.current_weather.windspeed+" km/h";
    document.getElementById("icon").textContent = icons[w.current_weather.weathercode] || "â›…";

    // AQI
    let pm = a.hourly.pm2_5[0];
    let ai = aqiInfo(pm);
    const aqiCard = document.getElementById("aqiCard");
    aqiCard.innerHTML = `<h4>ğŸŒ« AQI (PM2.5)</h4>
      <div>${pm} Âµg/mÂ³</div>
      <div>${ai.label}</div>
      <div style="font-size:12px">${ai.advice}</div>`;

    // HOURLY
    const hourlyDiv = document.getElementById("hourlyTemp");
    hourlyDiv.innerHTML="";
    const temps = w.hourly.temperature_2m.slice(0,24);
    const nowHour = new Date().getHours();
    const minT = Math.min(...temps), maxT = Math.max(...temps), range = maxT-minT||1;
    temps.forEach((t,i)=>{
      const h = 20 + ((t-minT)/range)*100;
      const hourLabel = i===0?"Now":(nowHour+i)%24+":00";
      const div = document.createElement("div");
      div.style.cssText="display:flex;flex-direction:column;align-items:center";
      div.innerHTML=`<div style="height:${h}px;width:20px;background:#4fc3f7;border-radius:6px"></div><div style="font-size:11px;margin-top:2px">${hourLabel}</div>`;
      hourlyDiv.appendChild(div);
    });

    // 7-DAY
    const forecastDiv = document.getElementById("forecast");
    forecastDiv.innerHTML="";
    const minAll = Math.min(...w.daily.temperature_2m_min);
    const maxAll = Math.max(...w.daily.temperature_2m_max);
    const rangeD = maxAll-minAll||1;
    w.daily.time.forEach((d,i)=>{
      const minH = 20 + ((w.daily.temperature_2m_min[i]-minAll)/rangeD)*60;
      const maxH = 20 + ((w.daily.temperature_2m_max[i]-minAll)/rangeD)*60;
      const div = document.createElement("div");
      div.style.cssText="display:flex;flex-direction:column;align-items:center";
      div.innerHTML=`<div style="display:flex;flex-direction:column;justify-content:flex-end;height:80px;width:16px;margin-bottom:4px">
        <div style="height:${maxH}px;background:#ff6347;border-radius:6px 6px 0 0;width:100%"></div>
        <div style="height:${minH}px;background:#4fc3f7;border-radius:6px 6px 0 0;width:100%"></div>
      </div>
      <div>${icons[w.daily.weathercode[i]]||"â›…"}</div>
      <div style="font-size:11px">${d.slice(5)}</div>`;
      forecastDiv.appendChild(div);
    });

    // Compass
    if("DeviceOrientationEvent" in window){
      window.addEventListener("deviceorientation", e=>{
        if(e.alpha!=null){
          const deg = Math.round(e.alpha);
          const compassDiv = document.getElementById("compassDiv");
          compassDiv.innerHTML = `<h4>ğŸ§­ Wind Direction</h4>
            <div>${deg}Â°</div>
            <div>${compassDirection(deg)}</div>`;
        }
      });
    }

  }catch(err){alert("Weather load failed"); console.error(err);}
  finally{showLoading(false);}
}

// Geolocation
function detectLocation(){
  const locEl = document.getElementById("location");
  locEl.textContent = "Detecting locationâ€¦";
  const fallback = ()=>loadWeather(28.6139,77.2090,"Delhi, IN");
  if(!navigator.geolocation){ fallback(); return; }
  let called=false;
  const timer = setTimeout(()=>{if(!called){called=true; fallback();}},10000);
  navigator.geolocation.getCurrentPosition(
    pos=>{if(called)return; called=true; clearTimeout(timer); loadWeather(pos.coords.latitude,pos.coords.longitude,"Current Location");},
    err=>{if(called)return; called=true; clearTimeout(timer); fallback();},
    {timeout:10000, enableHighAccuracy:true}
  );
}

// Search city
async function searchCity(){
  const city = document.getElementById("cityInput").value.trim();
  if(!city) return;
  try{
    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`);
    const data = await res.json();
    if(!data.results || !data.results.length) return alert("City not found");
    const c = data.results[0];
    loadWeather(c.latitude, c.longitude, c.name + (c.country?", "+c.country:""));
  }catch(err){alert("City search failed"); console.error(err);}
}

// Dark mode
const darkToggle = document.getElementById("darkToggle");
darkToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
};
if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");

// PWA install
const installBtn = document.getElementById("installBtn");
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display='block';
});
installBtn.addEventListener('click', async ()=>{
  if(!deferredPrompt) return;
  installBtn.style.display='none';
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
});

// Service Worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(e=>console.error(e));
}

// Start
document.getElementById("locateBtn").onclick = detectLocation;
detectLocation();
</script>
</body>
</html>
