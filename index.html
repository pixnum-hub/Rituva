<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Rituva Weather</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a1a1a">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#000; --soft:#1a1a1a; --card:#2a2a2a; --text:#fff;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  font-size:18px;
  line-height:1.5;
}
.app{max-width:480px;margin:auto;padding:16px;}
.header{font-size:30px;font-weight:900;margin-bottom:12px}
input,.btn,.card{width:100%;max-width:100%;box-sizing:border-box;}
input,.btn{padding:16px;border-radius:18px;border:none;background:var(--soft);color:white;font-size:18px;margin-bottom:12px;}
.btn{font-weight:700}
.location{font-size:22px;font-weight:700;margin:10px 0}
.temp{font-size:72px;font-weight:900;text-align:center;margin:10px 0}
.icon{text-align:center;font-size:52px;margin-top:-10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.card{background:var(--card);border-radius:20px;padding:16px}
.card-title{font-size:16px;opacity:.9}
.card-value{font-size:30px;font-weight:800}
.section{margin-top:22px}
.section-title{font-size:22px;font-weight:800;margin-bottom:10px}
.week{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.day{background:var(--soft);border-radius:16px;padding:12px;text-align:center}
.day-name{font-size:16px;font-weight:700}
.day-temp{font-size:18px;font-weight:800;margin-top:6px}
.hourly-scroll{display:flex;overflow-x:auto;gap:10px;padding-bottom:6px}
.hour{min-width:80px;background:var(--soft);padding:10px;border-radius:14px;text-align:center}
.hour-time{font-weight:700;font-size:14px}
.hour-temp{font-size:18px;font-weight:800;margin-top:4px}
.footer{text-align:center;font-size:13px;opacity:.6;margin:18px 0}
@media(min-width:768px){.app{max-width:720px}.temp{font-size:86px}}
@media(max-width:400px){.app{padding:12px}.temp{font-size:60px}input,.btn{padding:14px;font-size:16px}.card{padding:12px}}
</style>
</head>
<body>
<div class="app">
<div class="header">üå¶ Rituva</div>
<input id="city" placeholder="Search city">
<div class="btn" onclick="searchCity()">Search</div>
<div class="btn" onclick="detectLocation(true)">üìç Use My Location</div>
<div class="location" id="place">Detecting location‚Ä¶</div>
<div class="temp" id="temp">--¬∞C</div>
<div class="icon" id="icon">‚òÅÔ∏è</div>

<div class="grid">
  <div class="card"><div class="card-title">AQI (US)</div><div class="card-value" id="aqi">--</div></div>
  <div class="card"><div class="card-title">Wind (km/h)</div><div class="card-value" id="wind">--</div></div>
  <div class="card"><div class="card-title">Humidity (%)</div><div class="card-value" id="humidity">--</div></div>
  <div class="card"><div class="card-title">Rain Chance (%)</div><div class="card-value" id="rain">--</div></div>
</div>

<div class="section">
  <div class="section-title">Sunrise / Sunset</div>
  <div class="grid">
    <div class="card"><div class="card-title">Sunrise</div><div class="card-value" id="sunrise">--:--</div></div>
    <div class="card"><div class="card-title">Sunset</div><div class="card-value" id="sunset">--:--</div></div>
  </div>
</div>

<div class="section">
  <div class="section-title">Next 24 Hours</div>
  <div class="grid">
    <div class="card"><div class="card-title">Min Temp</div><div class="card-value" id="tmin">--¬∞</div></div>
    <div class="card"><div class="card-title">Max Temp</div><div class="card-value" id="tmax">--¬∞</div></div>
  </div>
</div>

<div class="section">
  <div class="section-title">Hourly Forecast</div>
  <div class="hourly-scroll" id="hourly"></div>
</div>

<div class="section">
  <div class="section-title">7-Day Forecast</div>
  <div class="week" id="week"></div>
</div>

<div class="footer">Powered by Open-Meteo</div>
</div>

<script>
const days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const placeEl=place,tempEl=temp,windEl=wind,aqiEl=aqi,tminEl=tmin,tmaxEl=tmax,weekEl=week,hourlyEl=hourly,iconEl=icon,cityInput=city;
const humidityEl=document.getElementById("humidity");
const rainEl=document.getElementById("rain");
const sunriseEl=document.getElementById("sunrise");
const sunsetEl=document.getElementById("sunset");

function weatherIcon(code){
  if(code===0) return "‚òÄÔ∏è";
  if(code<=3) return "‚õÖ";
  if(code<=48) return "üå´Ô∏è";
  if(code<=67) return "üåßÔ∏è";
  if(code<=77) return "‚ùÑÔ∏è";
  if(code<=82) return "üå¶Ô∏è";
  if(code<=99) return "‚õàÔ∏è";
  return "‚òÅÔ∏è";
}

// US AQI calculation for PM2.5
function usAQI(pm){
  const breakpoints=[
    {c_lo:0.0,c_hi:12.0,i_lo:0,i_hi:50},
    {c_lo:12.1,c_hi:35.4,i_lo:51,i_hi:100},
    {c_lo:35.5,c_hi:55.4,i_lo:101,i_hi:150},
    {c_lo:55.5,c_hi:150.4,i_lo:151,i_hi:200},
    {c_lo:150.5,c_hi:250.4,i_lo:201,i_hi:300},
    {c_lo:250.5,c_hi:500.0,i_lo:301,i_hi:500}
  ];
  for(const b of breakpoints){
    if(pm >= b.c_lo && pm <= b.c_hi){
      return Math.round((b.i_hi-b.i_lo)/(b.c_hi-b.c_lo)*(pm-b.c_lo)+b.i_lo);
    }
  }
  return pm;
}

function aqiColorUS(aqi){
  if(aqi<=50) return "#2ecc71";
  if(aqi<=100) return "#f1c40f";
  if(aqi<=150) return "#e67e22";
  if(aqi<=200) return "#e74c3c";
  if(aqi<=300) return "#8e44ad";
  return "#7f1d1d";
}

async function loadWeather(lat,lon,label){
try{
  placeEl.innerText="Loading‚Ä¶";

  const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&current_weather=true`+
    `&hourly=temperature_2m,relativehumidity_2m,precipitation_probability`+
    `&daily=temperature_2m_min,temperature_2m_max,weathercode,sunrise,sunset`+
    `&timezone=auto`;

  const w=await fetch(url).then(r=>r.json());

  tempEl.innerText=w.current_weather.temperature+"¬∞C";
  windEl.innerText=Math.round(w.current_weather.windspeed);
  iconEl.innerText=weatherIcon(w.current_weather.weathercode);

  humidityEl.innerText=Math.round(w.hourly.relativehumidity_2m[0]);
  rainEl.innerText=Math.round(w.hourly.precipitation_probability[0]);

  tminEl.innerText=Math.min(...w.hourly.temperature_2m.slice(0,24))+"¬∞";
  tmaxEl.innerText=Math.max(...w.hourly.temperature_2m.slice(0,24))+"¬∞";

  hourlyEl.innerHTML="";
  for(let i=0;i<24;i++){
    const h=new Date(w.hourly.time[i]).getHours();
    hourlyEl.innerHTML+=`<div class="hour"><div class="hour-time">${h}:00</div><div class="hour-temp">${w.hourly.temperature_2m[i]}¬∞</div><div style="font-size:14px;">‚òî${w.hourly.precipitation_probability[i]}%</div></div>`;
  }

  sunriseEl.innerText=new Date(w.daily.sunrise[0]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  sunsetEl.innerText=new Date(w.daily.sunset[0]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  weekEl.innerHTML="";
  for(let i=0;i<w.daily.time.length;i++){
    const d=new Date(w.daily.time[i]);
    weekEl.innerHTML+=`<div class="day"><div class="day-name">${days[d.getDay()]}</div><div style="font-size:26px">${weatherIcon(w.daily.weathercode[i])}</div><div class="day-temp">${w.daily.temperature_2m_min[i]}¬∞ / ${w.daily.temperature_2m_max[i]}¬∞</div></div>`;
  }

  placeEl.innerText=label;

  const air=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=pm2_5`).then(r=>r.json());
  const pm=Math.round(air.current.pm2_5);
  const aqi=usAQI(pm);
  aqiEl.innerText=aqi;
  aqiEl.style.color=aqiColorUS(aqi);

}catch(err){console.error(err);placeEl.innerText="Weather load failed";}
}

function detectLocation(force){
if(!navigator.geolocation){placeEl.innerText="Location not supported";return;}
placeEl.innerText="Detecting location‚Ä¶";
navigator.geolocation.getCurrentPosition(
  pos=>loadWeather(pos.coords.latitude,pos.coords.longitude,"Your Location"),
  ()=>placeEl.innerText=force?"Permission denied. Search city.":"Tap üìç Use My Location",
  {enableHighAccuracy:true,timeout:20000,maximumAge:0}
);
}

async function searchCity(){
const q=cityInput.value.trim();
if(!q)return;
placeEl.innerText="Searching‚Ä¶";
try{
  const geo=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json());
  if(!geo.results){placeEl.innerText="City not found";return;}
  const c=geo.results[0];
  loadWeather(c.latitude,c.longitude,`${c.name}, ${c.country}`);
}catch{placeEl.innerText="Search failed";}
}

// PWA registration
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js')
    .then(reg => console.log('SW registered:', reg.scope))
    .catch(err => console.log('SW registration failed:', err));
  });
}

// Offline / online notice
window.addEventListener('offline', ()=>{ placeEl.innerText="You are offline. Showing cached data."; });
window.addEventListener('online', ()=>{ detectLocation(false); });

window.addEventListener("load",()=>detectLocation(false));
</script>
</body>
</html>
