<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rituva â€“ Smart Weather</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<style>
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{
  margin:0;min-height:100vh;display:flex;justify-content:center;
  align-items:flex-start;padding:12px;overflow:auto;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#000;transition:.3s;
}
body.dark{
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.app{
  width:100%;max-width:380px;min-height:100vh;
  padding:16px;border-radius:22px;
  backdrop-filter:blur(18px);
  background:rgba(255,255,255,0.18);
  border:1px solid rgba(255,255,255,.35);
  display:flex;flex-direction:column;
}
body.dark .app{background:rgba(0,0,0,.35)}
input,button{
  width:100%;padding:12px;border-radius:12px;
  border:none;margin-bottom:10px;text-align:center;
}
button{background:rgba(255,255,255,.35);font-weight:bold}
.icon{font-size:48px}
.details{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:15px}
.detail-card{
  background:rgba(255,255,255,.2);
  border-radius:16px;padding:12px;text-align:center
}
body.dark .detail-card{background:rgba(0,0,0,.4)}
.big{font-size:26px;font-weight:bold}
.label{font-size:13px}
.hint{font-size:12px;margin-top:6px}

.hourly,.forecast{
  display:flex;gap:10px;overflow-x:auto;
  margin-top:12px;height:140px;padding:6px
}
.hour,.day{
  min-width:36px;display:flex;
  flex-direction:column;align-items:center;justify-content:flex-end
}
.hour-label,.day-label{font-size:11px}

.day-bar-container{height:80px;width:16px;display:flex;flex-direction:column;justify-content:flex-end}
.day-bar-min{background:rgba(0,150,255,.6)}
.day-bar-max{background:rgba(255,80,50,.7)}

.aqi-good{color:#00e676}
.aqi-moderate{color:#ffeb3b}
.aqi-poor{color:#ff9800}
.aqi-severe{color:#ff5252}

#installBtn{display:none}

.loading-overlay{
  position:absolute;inset:0;
  background:rgba(255,255,255,.25);
  backdrop-filter:blur(10px);
  display:none;align-items:center;justify-content:center;
  border-radius:22px;font-size:18px
}

.footer{
  margin-top:16px;font-size:11px;
  opacity:.8;text-align:center
}
</style>
</head>

<body>
<div class="app">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h1>ðŸŒ¦ Rituva</h1>
    <button id="darkToggle" style="width:42px;height:42px;border-radius:50%">ðŸŒ“</button>
  </div>

  <input id="cityInput" placeholder="Search city">
  <button onclick="searchCity()">Search</button>
  <button id="installBtn">ðŸ“² Install Rituva</button>

  <div class="loading-overlay" id="loading">Loadingâ€¦</div>

  <div class="current" style="text-align:center">
    <h2 id="location">Detecting locationâ€¦</h2>
    <div id="icon" class="icon">â›…</div>
    <p id="temp">--Â°</p>
    <p id="wind">ðŸŒ¬ -- km/h</p>
    <p id="pressure">ðŸ“Ÿ Pressure: -- hPa</p>
  </div>

  <div class="details">
    <div class="detail-card">
      <h4>ðŸ§­ Wind Direction</h4>
      <div id="compassValue" class="big">--Â°</div>
      <div id="compassDir" class="label">--</div>
    </div>
    <div class="detail-card" id="aqiCard">
      <h4>ðŸŒ« AQI (PM2.5)</h4>
      <div id="aqiValue" class="big">--</div>
      <div id="aqiLabel" class="label">--</div>
      <div id="aqiAdvice" class="hint">--</div>
    </div>
  </div>

  <h3>ðŸ•’ Next 24 Hours</h3>
  <div class="hourly" id="hourlyTemp"></div>

  <h3>ðŸ“… 7-Day Forecast</h3>
  <div class="forecast" id="forecast"></div>

  <footer class="footer">Â© Manik Roy 2025. All Rights Reserved.</footer>
</div>

<script>
const icons={0:"â˜€",1:"ðŸŒ¤",2:"â›…",3:"â˜",45:"ðŸŒ«",61:"ðŸŒ§",71:"â„",95:"â›ˆ"};
darkToggle.onclick=()=>document.body.classList.toggle("dark");
function showLoading(s){loading.style.display=s?"flex":"none"}

function aqiInfo(pm){
  if(pm<=30)return{l:"Good",a:"Safe outdoors",c:"aqi-good"};
  if(pm<=60)return{l:"Moderate",a:"Sensitive reduce exposure",c:"aqi-moderate"};
  if(pm<=90)return{l:"Poor",a:"Avoid long outdoor stay",c:"aqi-poor"};
  return{l:"Severe",a:"Stay indoors",c:"aqi-severe"};
}

async function loadWeather(lat,lon,name,country){
  try{
    showLoading(true);
    location.textContent=name?`${name}${country?", "+country:""}`:"Current Location";

    const w=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,surface_pressure&daily=temperature_2m_min,temperature_2m_max,weathercode&timezone=auto`
    ).then(r=>r.json());

    const a=await fetch(
      `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`
    ).then(r=>r.json());

    temp.textContent=`ðŸŒ¡ ${w.current_weather.temperature}Â°C`;
    wind.textContent=`ðŸŒ¬ ${w.current_weather.windspeed} km/h`;
    pressure.textContent=`ðŸ“Ÿ ${w.hourly.surface_pressure[0]} hPa`;
    icon.textContent=icons[w.current_weather.weathercode]||"â›…";

    const ai=aqiInfo(a.hourly.pm2_5[0]);
    aqiCard.className="detail-card "+ai.c;
    aqiValue.textContent=a.hourly.pm2_5[0]+" Âµg/mÂ³";
    aqiLabel.textContent=ai.l;
    aqiAdvice.textContent=ai.a;

  }catch{alert("Weather load failed")}
  finally{showLoading(false)}
}

/* ðŸ”¥ FAIL-SAFE LOCATION DETECTION */
function detectLocation(){
  if(!navigator.geolocation){
    loadWeather(28.6139,77.2090,"Delhi","IN");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      try{
        const r=await fetch(
          `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&count=1`
        ).then(r=>r.json());

        if(r.results&&r.results.length){
          loadWeather(lat,lon,r.results[0].name,r.results[0].country);
        }else{
          loadWeather(lat,lon,"Current Location","");
        }
      }catch{
        loadWeather(lat,lon,"Current Location","");
      }
    },
    ()=>loadWeather(28.6139,77.2090,"Delhi","IN"),
    {timeout:8000}
  );
}

async function searchCity(){
  const q=cityInput.value.trim();
  if(!q)return;
  const g=await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`
  ).then(r=>r.json());
  if(!g.results)return alert("City not found");
  const c=g.results[0];
  loadWeather(c.latitude,c.longitude,c.name,c.country);
}

/* PWA */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
}
let deferredPrompt;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();deferredPrompt=e;
  installBtn.style.display="block";
});
installBtn.onclick=async()=>{
  if(!deferredPrompt)return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  installBtn.style.display="none";
};

detectLocation();
</script>
</body>
</html>
