<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rituva</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;min-height:100vh;display:flex;justify-content:center;
padding:12px;background:linear-gradient(135deg,#667eea,#764ba2)}
.app{width:100%;max-width:380px;padding:16px;border-radius:22px;
background:rgba(255,255,255,.18);backdrop-filter:blur(16px)}
input,button{width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px}
button{font-weight:bold;background:rgba(255,255,255,.35)}
.icon{font-size:48px;text-align:center}
.details{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.detail-card,.feature-card,.day-card{
background:rgba(255,255,255,.25);border-radius:14px;padding:10px;text-align:center;font-size:13px}
.big{font-size:26px;font-weight:bold}
.feature-title{font-weight:bold}
.hourly{display:flex;gap:8px;overflow-x:auto}
.hour{display:flex;flex-direction:column;align-items:center}
.hour-bar,.temp-bar{width:18px;border-radius:6px 6px 0 0}
.hour-bar{background:#43a047}
.temp-bar{background:#ff7043}
#map{height:260px;border-radius:16px}
</style>
</head>

<body>
<div class="app">
<h1>ğŸŒ¦ Rituva</h1>

<button id="installBtn" style="display:none">ğŸ“² Install App</button>
<input id="cityInput" placeholder="Search city">
<button id="searchBtn">Search</button>
<button id="locBtn">ğŸ“ Use My Location</button>

<h2 id="location">Loadingâ€¦</h2>
<div id="icon" class="icon">â›…</div>

<p id="temp">--Â°</p>
<p id="feels">Feels --</p>
<p id="wind">Wind --</p>
<p id="humidity">Humidity --</p>

<div class="details">
<div class="detail-card">
<h4>ğŸ§­ Wind Dir</h4>
<div id="windDir" class="big">--</div>
</div>
<div class="detail-card">
<h4>ğŸŒ« AQI (India)</h4>
<div id="aqiValue" class="big">--</div>
<div id="aqiLabel">--</div>
</div>
</div>

<h3>ğŸŒ« AQI Insights</h3>
<div class="details" id="aqiFeatures"></div>

<h3>ğŸ“ˆ AQI Forecast (24H)</h3>
<div class="hourly" id="aqiGraph"></div>

<h3>ğŸŒ¡ Temperature (24H)</h3>
<div class="hourly" id="temp24h"></div>

<h3>ğŸ“… 7-Day Temperature</h3>
<div class="details" id="temp7d"></div>

<h3>ğŸ—º Pollution Heatmap</h3>
<div id="map"></div>

<footer style="text-align:center;font-size:11px;margin-top:15px">
Â© Manik Roy 2025
</footer>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const $=id=>document.getElementById(id);
let alertSent=false;

/* ---------- UTIL ---------- */
function compass(d){return["N","NE","E","SE","S","SW","W","NW"][Math.round(d/45)%8]}
function avg(a){return a.reduce((x,y)=>x+y,0)/a.length}

/* ---------- CPCB AQI ---------- */
function calc(c,b){return Math.round(((b[3]-b[2])/(b[1]-b[0]))*(c-b[0])+b[2])}
function aqiPM25(c){const t=[[0,30,0,50],[31,60,51,100],[61,90,101,200],[91,120,201,300],[121,250,301,400],[251,500,401,500]];for(let i of t)if(c<=i[1])return calc(c,i)}
function aqiPM10(c){const t=[[0,50,0,50],[51,100,51,100],[101,250,101,200],[251,350,201,300],[351,430,301,400],[431,600,401,500]];for(let i of t)if(c<=i[1])return calc(c,i)}
function aqiNO2(c){const t=[[0,40,0,50],[41,80,51,100],[81,180,101,200],[181,280,201,300],[281,400,301,400],[401,1000,401,500]];for(let i of t)if(c<=i[1])return calc(c,i)}
function aqiSO2(c){const t=[[0,40,0,50],[41,80,51,100],[81,380,101,200],[381,800,201,300],[801,1600,301,400],[1601,2000,401,500]];for(let i of t)if(c<=i[1])return calc(c,i)}

/* ---------- AI ---------- */
function maskAI(aqi){
if(aqi<=50)return"No mask needed ğŸ™‚";
if(aqi<=100)return"Cloth mask optional";
if(aqi<=150)return"Wear N95 mask";
if(aqi<=200)return"N95 mandatory";
return"Double mask / Avoid outdoor";
}
function aiPredictAQI(arr){
let avgVal=avg(arr),trend=arr[arr.length-1]-arr[0];
return Math.round(avgVal+trend*0.6);
}

/* ---------- GRAPHS ---------- */
function buildAQIGraph(a){
$("aqiGraph").innerHTML="";
const m=Math.min(...a),x=Math.max(...a),r=x-m||1;
a.forEach(v=>{
$("aqiGraph").innerHTML+=`
<div class="hour">
<div class="hour-bar" style="height:${30+((v-m)/r)*80}px"></div>
<small>${v}</small>
</div>`;
});
}
function buildTemp24H(t){
$("temp24h").innerHTML="";
const m=Math.min(...t),x=Math.max(...t),r=x-m||1;
t.slice(0,24).forEach(v=>{
$("temp24h").innerHTML+=`
<div class="hour">
<div class="temp-bar" style="height:${30+((v-m)/r)*80}px"></div>
<small>${Math.round(v)}Â°</small>
</div>`;
});
}
function buildTemp7D(maxT,minT){
$("temp7d").innerHTML="";
for(let i=0;i<7;i++){
$("temp7d").innerHTML+=`
<div class="day-card">
<b>Day ${i+1}</b><br>
ğŸŒ¡ ${Math.round(maxT[i])}Â° / ${Math.round(minT[i])}Â°
</div>`;
}
}

/* ---------- MAP ---------- */
let map,layer;
function initMap(lat,lon,aqi){
if(!map){
map=L.map("map").setView([lat,lon],10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
setTimeout(()=>map.invalidateSize(),200);
}
const col=aqi<=50?"#2ecc71":aqi<=100?"#f1c40f":aqi<=150?"#e67e22":aqi<=200?"#e74c3c":"#8e44ad";
if(layer)map.removeLayer(layer);
layer=L.circle([lat,lon],{radius:12000,color:col,fillColor:col,fillOpacity:.35}).addTo(map);
}

/* ---------- ALERT ---------- */
if("Notification"in window)Notification.requestPermission();
function sendAlert(aqi){
if(aqi>150&&!alertSent){
alertSent=true;
new Notification("âš  Pollution Alert",{body:"Air quality unhealthy. Avoid outdoor activity."});
}
}

/* ---------- MAIN ---------- */
async function loadWeather(lat,lon,name){

const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m&daily=temperature_2m_max,temperature_2m_min&timezone=auto`).then(r=>r.json());

const a=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10,nitrogen_dioxide,sulphur_dioxide&timezone=auto`).then(r=>r.json());

$("location").textContent=name;
$("temp").textContent=w.current_weather.temperature+"Â°C";
$("feels").textContent="Feels "+w.hourly.temperature_2m[0]+"Â°C";
$("wind").textContent="Wind "+w.current_weather.windspeed+" km/h";
$("humidity").textContent="Humidity "+w.hourly.relativehumidity_2m[0]+"%";
$("windDir").textContent=compass(w.current_weather.winddirection);

/* ---- 24H AVERAGE AQI ---- */
const pm25=avg(a.hourly.pm2_5.slice(0,24));
const pm10=avg(a.hourly.pm10.slice(0,24));
const no2 =avg(a.hourly.nitrogen_dioxide.slice(0,24));
const so2 =avg(a.hourly.sulphur_dioxide.slice(0,24));

const CURRENT=Math.max(
aqiPM25(pm25),
aqiPM10(pm10),
aqiNO2(no2),
aqiSO2(so2)
);

/* ---- Rolling AQI Graph ---- */
let hourlyAQI=[];
for(let i=0;i<24;i++){
hourlyAQI.push(Math.max(
aqiPM25(avg(a.hourly.pm2_5.slice(i,i+24))),
aqiPM10(avg(a.hourly.pm10.slice(i,i+24))),
aqiNO2(avg(a.hourly.nitrogen_dioxide.slice(i,i+24))),
aqiSO2(avg(a.hourly.sulphur_dioxide.slice(i,i+24)))
));
}

$("aqiValue").textContent=CURRENT;
$("aqiLabel").textContent=
CURRENT<=50?"Good":
CURRENT<=100?"Satisfactory":
CURRENT<=200?"Moderate":
CURRENT<=300?"Poor":
CURRENT<=400?"Very Poor":"Severe";

buildAQIGraph(hourlyAQI);
buildTemp24H(w.hourly.temperature_2m);
buildTemp7D(w.daily.temperature_2m_max,w.daily.temperature_2m_min);
sendAlert(CURRENT);
initMap(lat,lon,CURRENT);

$("aqiFeatures").innerHTML=`
<div class="feature-card"><div class="feature-title">Health Category</div>${$("aqiLabel").textContent}</div>
<div class="feature-card"><div class="feature-title">AI Predicted AQI</div>${aiPredictAQI(hourlyAQI)}</div>
<div class="feature-card"><div class="feature-title">Mask Advice</div>${maskAI(CURRENT)}</div>
<div class="feature-card"><div class="feature-title">AQI Standard</div>Indian CPCB</div>
`;
}

/* ---------- SEARCH ---------- */
$("searchBtn").onclick=async()=>{
const q=$("cityInput").value.trim();
if(!q)return;
const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json());
loadWeather(r.results[0].latitude,r.results[0].longitude,r.results[0].name);
};

/* ---------- LOCATION ---------- */
$("locBtn").onclick=()=>{
navigator.geolocation.getCurrentPosition(p=>
loadWeather(p.coords.latitude,p.coords.longitude,"Current Location"));
};

/* ---------- BOOT ---------- */
loadWeather(28.61,77.23,"Delhi, India");

/* ---------- PWA ---------- */
if("serviceWorker"in navigator)navigator.serviceWorker.register("sw.js");
let dp;
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();dp=e;$("installBtn").style.display="block";
});
$("installBtn").onclick=()=>dp.prompt();
</script>
</body>
</html>
