<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rituva – AQI & Weather</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000000" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  :root {
    --bg: #ffffff;
    --text: #000000;
  }
  body.dark {
    --bg: #121212;
    --text: #ffffff;
  }
  body.oled {
    --bg: #000000;
    --text: #ffffff;
  }
  header {
    padding: 10px;
    display: flex;
    gap: 5px;
  }
  input, button {
    padding: 6px;
    font-size: 14px;
  }
  #map {
    height: 350px;
    width: 100%;
  }
  .card {
    padding: 10px;
    margin: 8px;
    border-radius: 8px;
    background: rgba(0,0,0,0.05);
  }
  body.dark .card,
  body.oled .card {
    background: rgba(255,255,255,0.08);
  }
  footer {
    text-align: center;
    font-size: 11px;
    margin: 15px 0;
    opacity: 0.7;
  }
</style>
</head>

<body>
<header>
  <input id="cityInput" placeholder="Search city" />
  <button onclick="searchCity()">Search</button>
  <button onclick="toggleTheme()">Theme</button>
</header>

<div id="map"></div>

<div class="card" id="aqiCard">AQI: --</div>
<div class="card" id="aqiInsight">AQI Insights loading…</div>

<footer>© Manik Roy 2025. All Rights Reserved.</footer>

<script>
let map = null;
let heatLayer = null;
let themeIndex = 0;
const themes = ["", "dark", "oled"];

function toggleTheme() {
  themeIndex = (themeIndex + 1) % themes.length;
  document.body.className = themes[themeIndex];
  localStorage.setItem("theme", themes[themeIndex]);
}

document.body.className = localStorage.getItem("theme") || "";

async function fetchAQI(lat, lon) {
  const url =
    `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10,no2,so2&timezone=auto`;
  const res = await fetch(url);
  const data = await res.json();

  const pm25 = data.hourly.pm2_5.slice(-24);
  const avgPM25 = pm25.reduce((a, b) => a + b, 0) / pm25.length;

  return Math.round(avgPM25 * 2); // CPCB-like approximation
}

function drawMap(lat, lon, aqi) {
  if (!map) {
    map = L.map("map");
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);
  }

  map.setView([lat, lon], 11);
  map.invalidateSize(true);

  if (heatLayer) {
    map.removeLayer(heatLayer);
    heatLayer = null;
  }

  const intensity =
    aqi <= 50 ? 0.3 :
    aqi <= 100 ? 0.5 :
    aqi <= 150 ? 0.7 :
    aqi <= 200 ? 0.85 : 1.0;

  const spread = 0.05;
  const points = [];

  for (let x = -2; x <= 2; x++) {
    for (let y = -2; y <= 2; y++) {
      const d = Math.abs(x) + Math.abs(y);
      points.push([
        lat + x * spread / 4,
        lon + y * spread / 4,
        Math.max(0.2, intensity - d * 0.12)
      ]);
    }
  }

  heatLayer = L.heatLayer(points, {
    radius: 50,
    blur: 35,
    minOpacity: 0.45,
    maxZoom: 13
  }).addTo(map);
}

async function loadLocation(lat, lon, label) {
  const aqi = await fetchAQI(lat, lon);
  document.getElementById("aqiCard").innerText = `AQI (${label}): ${aqi}`;

  document.getElementById("aqiInsight").innerText =
    aqi <= 50 ? "Good – No mask needed" :
    aqi <= 100 ? "Moderate – Sensitive people take care" :
    aqi <= 200 ? "Poor – Mask recommended" :
    "Very Poor – Avoid outdoor activity";

  drawMap(lat, lon, aqi);
}

async function searchCity() {
  const city = document.getElementById("cityInput").value;
  if (!city) return;

  const res = await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1`
  );
  const data = await res.json();
  if (!data.results) return;

  const { latitude, longitude, name } = data.results[0];
  loadLocation(latitude, longitude, name);
}

navigator.geolocation.getCurrentPosition(pos => {
  loadLocation(pos.coords.latitude, pos.coords.longitude, "Current Location");
});

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
